<h1>SOC Automation (Home Lab) - Part 3</h1>

<p align="center">
<img src="https://snipboard.io/col95p.jpg" height="80%" width="80%" alt="Disk Sanitization Steps"/>
<h2>Description</h2>
<br />
<p align="center">
Welcome to the final part of the series of the SOC automation project. If you haven't seen the previous parts where we go over on how to build out a diagram for this lab, install, configure, and generate telemetry, I highly recommend you go and read that first to get up to speed.
  
In today's objective, it's going to be about connecting both our Shuffle, which is our SOAR platform. Which will then send an alert over to the Hive and to our analyst, such as yourself via an email to begin your work.

By the end of this video, you will have a fully functional lab that integrates Wazuh, the Hive, and Shuffle. Now, Wazuh alone does have a lot of these capabilities built-in, however, it is a good idea to be exposed to how we can utilize SOAR and a case management system like the Hive.

You want to stick around to the end because, I'll be introducing a relatively new tool that had helped me during my investigations. So you want to head over to Shuffle's site at Shuffle and then you want to create an account. 

Once you create an account, we can start creating our workflow. Now you'll be presented with this screen. Once you log in, we can either select "New to Shuffle" or "Experienced", but either way I'll just bypass everything and click on "Workflows".

From here, we can open up and create our own workflow by clicking on the plus button. I'll name this workflow as "SOC Automation Project" and the description will be "MyDFIR Project!". 

For the Usecase, we can do whichever. I'll just select any random one and then hit "Done". We get presented with this big "Change Me" icon. Now, this is your workplace where you get to start adding apps and triggers.

Now, let me just zoom out just a little bit. Although, you can't see it too well, because these applications are blocking it. There is a tab in the middle called "Triggers" and that is what we want to click on.

Now, we are presented with a couple of workflow starters. So there's "webhook", a scheduler, "Office365", and "Gmail". I'm going to select "webhook". Simply just drag and drop it. Once you've dragged and dropped the webhook, you want to select it and then on the right-hand side we can start naming our webhook to whatever we want to.

In our demom, I'll name this as "Wazuh-Alerts". For the "Find Associated App", it is optional so I'll leave it as blank. What I want to do is copy the webhook URI. The reason we copy this webhook is because we'll need to add this into our "ossec" configuration posted on our Wazuh manager.

However, before we head over to the Wazuh manager, let's click on the "Change Me" icon and just make sure that it is selected as "Repeat back to me". For the call, I'll remove "Hello world" and I'll click on this plus button. Select "Execution Argument" and then I'll save it now.

Let's head over to our Wazuh manager. On our Wazuh manager CLI, we need to tell Wazuh that we're going to connect to Shuffle and we can do this by adding what is called an Integration Tag in the "ossec" configuration file. So let's go ahead and open that up. 

If you don't remember, it is under "/var/ossec/etc/ossec.conf". From here, I'm just going to scroll down just a little bit right after the "global" tag. Now, you could place this anywhere you like but I'm just going to place it here. Then, I'm going to copy and paste this integration tag similar like the other configuration files.

You do want to keep in mind of the indentation. If you don't know how many spaces there are, just look above and try to match it so it's the same. Now, that the integration tag is there, we want to replace the URL where it says your "SHUFFLE_URL". Let's go ahead and remove all of that, including the "HOOK_ID". Then, paste in the webhook that you copied earlier.

After you pasted in your Shuffle webhook, you want to make sure that your "hook_url" is not included as the URL. So you want to press space in between to make sure that your "hook_url" is white and not purple because if it is purple, it'll think that it's related to the Shuffle URL. As a side note, if I press "Space" it separates it from the URL itself. That is what we want to do.

Now, by default it has a level of three. So this means that any alert that has a level of three will be sent to Shuffle. Now, I personally don't want this and instead I want only our "rule_id" that we created, which was '100,002' and that was our Mimikats rule that we created earlier.

Again, if we wanted to send all alerts that were generated with a level of three or whatever the number is, we need to change the number to reflect that level. However, because I want a "rule_id" instead of a level number, I will change the level tag to "rule_id" tag.

So for example, again just to make sure that we are all on the same page. If I wanted to send all level five alerts to Shuffle, I will need to change it from '3' to '5'. In my case, because I don't want level and I want "rule_id", I will remove the level and type in "rule_id".

Then I'll change my '5' to '100,002'. Make sure you close it off correctly by typing in "rule_id". So this looks good. Our indentation is good to go. My "hook_url" is not attached to the URL itself and my "rule_id" is '100,002'. I'll go ahead and save this out

Remember, if we make any changes to our configuration, you want to restart your Wazuh manager service. Once that is restarted, let's just make sure it's good to go. So we'll type in, "systemctl status wazuh-manager service".

Let's go and regenerate the Mimikats telemetry on our Windows client machine. So I have my Powershell here. I'll exit out of that and then type in ".\youareawesome.exe". Hit "Enter". Now, let's head over to our Shuffle instance.

Click on our webhook and make sure you select "Start". Now let's click on the person icon at the bottom. As this will show us any executions. So we'll click on that and let's go and test workflow. Now that is extremely strange, there is no events pushing over to my Shuffle.

So let's do a little bit of troubleshooting, shall we? We'll go back to our Wazuh manager and we'll open up the configuration file. Now, I just need to make sure to read my URL or anything such as my "rule_id" I do recall seeing that it's '102' which is correct, but if you look at the URL there's "HTTP" and "https" so that is clearly wrong.

We will remove "HTTP" and save that out. Now that should be good. Let's restart Wazuh manager. Now that's done, let's head back over to our client machine. Exit out of Mimikatz. I'm going to clear the screen because it's getting quite messy and then type in ".\youareawesome.exe".

Now we should see some events in Shuffle. Now let's go ahead and click on this, select the "Execution Argument," and expand that. Look at that, we get all of the information that was generated from Wazuh itself. Isn't that awesome. Think about all the possibilities that we can do.

The workflow that we will build for Mimikatz today will only work for this demo, but the same concepts can be applied to other use cases. As long as you follow the guidelines and read the instructions, you should be good to customize your own alerts and automation.

Here is the workflow that we will be creating today. We will have our Mimikatz alert be sent over to Shuffle, Shuffle will then take that and extract the file hash from the file, and then check the reputation score using VirusTotal. We will then send that over to the Hive to create an alert and then we will send an email to the analyst so they can perform further investigation.

When we look at our return values for the hashes, we notice that its appended by their hash type. For example, in this case it is appended by "SHA1=" and then the hash value. If we wanted to automate this, we would need to parse out the hash value itself, because the entire value including the "SHA1=" will be sent over to, let's say VirusTotal, to check and we don't want to do that, we just want to send VirusTotal the hash value..

Why don't we actually do that? So let's close this out. I'll click on the "Change Me" icon and instead of "Repeat back to me", we actually have a couple of other options that we can use. So we can type in "regex" and select Rexgex capture group.

For the input data, we can select the plus button and select "Execution Argument" and let's look for our hash. Now if you highlight over it, you'll actually get the values or the output on the left-hand side.

Now at the bottom, it tells us to do some rexgex. Do you know how to write regex by any chance? If not, that is perfectly fine. We can head over to our trusty ChatGPT. Using ChatGPT, we can create a prompt saying "create a regex to parse the sha256 value of the hash" and then I'll hit "Enter".

Right off the bat, ChatGBT created a regex for us. So we can start copying that. Once it's finished talking, I'll scroll back up to copy the regex and then I'll head over to Shuffle. Now, we can paste in the regex that ChatGBT created for us and use AI to our advantage in these types of cases.


Once we pasted that in, let's save our workflow and then we can click on the person icon. Then, click on the refresh button or rerun workflow button at the top. We'll click on that and then if we were to expand our results, we can see that it parsed out the sha256 hash. Now, when we encounter something that we aren't too familiar with, don't be afraid to utilize ChatGPT and ask it to help you.

We can utilize AI to our advantage to allow us to become better at what we do. Now, that you have parsed the hash value for the file, we can automatically send that over to VirusTotal and check the reputation score. Now, I will rename "Change Me" to "SHA256_Regex".

The next thing we want to do is utilize VirusTotal's API. That that way we can automatically ask VirusTotal to check this hash and return the values to us. In order to utilize their API, we must create an account with them. So let's go and do that.

You can head over to VirusTotal's site and then click on "Sign up" on the top-right corner. Once you've created your account, go ahead and copy your API key and then head back over to Shuffle. Once we're in Shuffle, we can click on "Apps" and then we want to search for VirusTotal and hit "Enter".

Now, we can click on VirusTotal and then it will activate VirusTotal onto our Shuffle instance. Once that's done, go ahead and drag VirusTotal over and it will automatically connect. Now, when you click on VirusTotal, rename it as "Virustotal".

For "Find Actions", I don't want an IP address. Instead, I want to look for a hash. So I'll click on the drop-down. Now, you might only see one action. That's okay, that's simply because VirusTotal is still activating in the background. You want to wait just a bit and then more actions will populate.

So it's been a couple minutes and I went ahead and refreshed my Shuffle instance. Now, when I click on VirusTotal under the "Find Actions", I can see more actions. Again, I'm not looking for an IP address report. Instead, I want to look for the hash. So I'll type in "hash", and I can find that there's a hash report.

If you want, you can paste in your API key here or you can authenticate with "VirusTotal V3". By clicking on "AUTHENTICATE VIRUSTOTAL V3", I'll paste in my API key that I copied from Virustotal. Then, I'll hit "Submit". Make sure for the hash section, to select the regex output.

Right now, it's pointing to "$exec.all_fields.agent.ip" and we don't want that. We want to select the regex output for "list". Since again, the rexgex is there to parse out the value of the hash. Now, I'll go ahead and save the workflow.


Click on the person icon and then we'll select the middle workflow option. Then, we'll rerun workflow. Now let's take a look at VirusTotal's output. We'll go ahead and expand that and we notice that the status is '404'. So that is quite strange. This means that VirusTotal was not able to return any results for us.

Now, if we were to look at the query itself in the URL section. We see that it's going to "api/v3/files/report" and then we see our "hash=" the hash value. So this seems about right, but how come it's giving us a '404' error?

Let's head over to VirusTotal's API documentation. If I were to scroll down we see that there is a "Get a file report by hash" and that is what we're interested in. So I'll go ahead and click on that and I want you to take a look at the URL here.

It is going to "api/v3/files/{id} and that's interesting. So if we were to go back into our Shuffle. Our URL is going to "/api/V3/files/report". The documentation mentioned nothing about "report". So maybe that is why we are getting a '404' error. The VirusTotal app in Shuffle has an incorrect URL or it was probably correct before but VirusTotal updated its API.

Now, how do we fix this? We can actually head over to VirusTotal's app and edit it. So to do that, let's head over to apps. Once you are in the application page, you want to select the new window under the VirusTotal app. You'll be presented with VirusTotal's application page for Shuffle. What you want to do is "Fork" over the application so you can edit it.

So let's click on that. Scroll down and then let's find our hash report. Now, we can see that it is indeed referencing "report". As you recall looking at API documentation on VirusTotal, it did not mention anything about "report". Instead, it was pointing towards an ID variable enclosed in curly brackets.

So that's what I'll do. I'll change that and then hit "Submit". I'll scroll down and save it out. Let's try this again. I've placed the edited VirusTotal onto our workflow so I'll go ahead and select that. Again, you do have an option to authenticate with the API key or you can click on the plus icon to authenticate. I will be using the API key, so I'll paste in my VirusTotal API key and hit "Submit".

Now, I do not want to get an IP address report. Change this to "Get a hash report". Change the ID to the regex ID. Then, we'll go ahead and save the workflow and rerun it. Click on "Rerun" and let's expand VirusTotal. Look at that, it's a lot different. If we scroll down to "last_analysis_stats".

We can see that it says "malicious : 63". That means that '63' scanners had detected this file as malicious. Now, you might be asking how did I know which field to use or the reputation, and that's a great question. When I search our hash through VirusTotal, we can see that it detects '63' out of '71'.

All we need to do now is grab the output that Shuffle had provided us and search for '63'. So we obtained the field name, which in our case was malicious under the last analysis stats, which sounds about right. To quickly recap, we set up our SOAR platform to receive our Wazuh alert. We then performed regex to parse out the sha256 hash, and we then used VirusTotal to check its reputation.

Next we will send the details over to the Hive, so the Hive can create an alert for case management. so under the application tab at the bottom leftand corner we want to search for The Hive and we want the hive five so click on that and then we will TheHive drag it over to our workflow and then let's take a look at the action now we might again see only one action but that is okay it is just loading in the background what you can also do is if you don't want to wait you can try refreshing your workflow to see if the hive actions will populate so I went ahead and refreshed my workflow and I do see a lot more actions before we move on with Shuffle let's head over to The Hive if you recall we can log in using the default credentials of admin atthehive dolo and the password is Secret by default we only have one organization and that is named admin let's create a new organization and create a new user for that organization to do that you want to click on the plus button at the top left corner and as an organization name I'll just name this as my dfir and the description sock automation project and I'll confirm that now that we have a new organization go ahead and click into it immediately it says no users have been found so let's add two users the first user I'll leave the type as normal and the login will be my dfir at test.com with the name I'll put it as my dfir and the profile you can select a couple of permissions here reason analyst and or- admin I'm going to select analyst as the profile and I will save and add another user this time instead of selecting normal I'm going to select service account or in this case just service for the login I will type in Shuffle test.com and the name I'll just type in sore as for the profile we do have readon analyst and org admin in a real world environment you would want to create a new set of permissions with the principle of lease privilege in mind and tie that to the service account principle of lease privilege for those that don't know is where an account is given the minimum level of permission to perform its function in our case again because it is a demo environment we're okay to just select it as analyst and I will hit confirm the next thing we want to do is create a password for the my dfir account we can highlight the account and select preview scroll down and then you will see set a new password once you set a password hit confirm and then for the sore user you want to select preview and you want to create an API key for this user once your API key is created go ahead and copy that out and make sure you put it somewhere safe because we will be using this to authenticate with Shuffle now I will log out of this administrative account and then I will log into my DFI account once you log in you're now presented with a different page we can actually see cases well in this case no cases have been found but we can see cases here and we can also see alerts now let's head over to shuffle and configure that to work with The Hive on our Shuffle instance we want to select the plus button beside authenticate because we want to authenticate to The Hive using our API key copy the API key over and paste it into your hive as for for the URL you want to typee in the public IP of your hive instance along with the port number so in my case my hive instance public IP address is 14310 21714 n on Port 9000 and then I will hit submit great now under the find action I don't want to query the API instead I want to create an alert so I will select create alert and at the bottom we can ignore a first couple options however the one that we need to add on is the date now to get the date we must connect our Hive to the workflow so I'll connect virus total to The Hive that way it can now take a look into our Wasa alert so selecting the date I'll click on the plus button and then I'll click on execution arguments now before I even go through that I want to actually show you what it looks like without the connection so if I don't connect anything and if I go back to the date and click on the plus button I don't see anything well I see something but I don't see virus total and stuff like that now I do want to connect it so logically I can see how it flows I'll select date and hit the plus and now I can see the Sha 256 and virus total as well it just seems a lot cleaner to me so that's why I like to make sure I connect things together now we'll go into execution argument and then then we'll look for the time field in this case it's right here UTC time now if you're not sure again if you just highlight the field it will populate the field value on the left hand side I'll select UTC time as for the description let's type in mimic cats detected on host and let's select the field name that contains the host oh I believe computer looks to be good yep that looks good mimik cats detected on host computer from maybe the user is good to put on right so let's add on the user we scroll all the way down I think there should be a user somewhere here oh right here user so if I were to receive an alert what are some of the fields that will provide a lot of information now this is very subjective depending on the analyst itself but for the sake of this demo I'll just leave it as these two for now external link we don't need to add anything for the flag we'll put it as false as for the value two is the default according to the documentation Pap is permissible actions protocol aka the level of exposure of information next is severity which I will put it as two The Source typically this is where the alert is coming from I'll just say Wasa and the source reference just a little bit of metadata for the alert itself I'll just put in the rule ID so 100,2 the status is the status of the alert that will be created in the hive so we want the status to be new and then the summary similar to the description but a little bit more information I'll type in mimik cats activity detected on host let's select the host again where's the computer here and the process ID is to find the process ID this is all up to you on what kind of information you want it to spit out but essentially I'm going to ask it for the process ID and the command line and the command line is search for the command line perfect awesome now you can keep building this but again for the sake of the demo I'll just leave it as is but the tags we need to put this into an array I'll put in the miter attack tag which is t13 AKA credential dumping and then the title the title is mimik cats detected now this is very static what we can do is actually just tie it to the alert itself and that's what I'll do top is the traffic light protocol so the confidentiality of information I'll leave it as two and the type where did you find this typically internal or where did that alert come from now let's go ahead and save this workflow and before before we go ahead and run the workflow we'll need to modify our Cloud firewall to allow all IPS coming inbound on Port 9000 because that is where my hive instance will live and this will be a temporary rule to allow us to test this automation so let's head over to our digital ocean and click on networking head over to our firewalls and then select our firewall that we created now we want to create a new rule and put it as custom and then we want to add in the ports as 9,000 we will remove all IPv6 but we will keep all ipv4 and then I'll save it out now any Source will have access to our machines on Port 9000 heading back to our Shuffle we can now rerun the workflow so click on the person icon and then rerun workflow scrolling down it looks like the hive was successful so let's go into our Hive instance and look at that automatically the alert was created mimic cats usage detected click on that and we have our description mimic cats detected on host desktop Das that from user Sally and the summary mimik cat's detection on host that host and the process ID is 9848 and the command line is that command line now you can see how powerful this is if you really put in more effort into the summary and description because that will tell the analyst a bunch of information very quickly the next step is to send an email to our analyst containing relevant information to do that you can click on apps at the bottom left and drag the email application and then connect virus total over to the email now we can enter in the recipient so I can literally type in any email I want as long it is a valid email now if you don't want to use your personal email well I want to introduce you to our sponsor squarex not only do they offer disposable email they also have what are called disposable web browsers and file viewers I've personally switched over to use this tool to help me perform additional investigations especially when I want to perform some Dynamic browser analysis because there are times when I am curious what the particular website would do if accessed perhaps a file was downloaded or maybe the site redirected you to another site that then hosts suspicious or malicious activity now of course with every investigation you want to do your due diligence and perform what is called passive analysis on your ioc's your indicators of compromise before you think about Dynamic analysis but after you've done your due diligence and perhaps been given the green light from senior analyst using Square X's disposable products are super easy to use and convenient because of this I've switched from using other browser tools to using squarex I want you to imagine a scenario you receive an alert about file execution of rundll32 performing an outbound connection to a potential C2 server now you begin performing your triage and by looking at the surrounding events you do notice that the user had gone to this is evil.com prior to the alert you perform your research and have done passive analysis on the site and notice that it is a widespread campaign and is not directly targeting your organization because of that your senior analyst wants you to find some more information about this site because it is a widespread campaign to go ahead and perform additional research onto that site now you might ask how do you do that what do you do next you can utilize other web browser tools to obtain metadata but that's about it some tools would even take a snapshot and then give you that metadata however with square X you can browse to that site safely and see what that site might do if you click on a certain link what this means is dynamic browser analysis understand what that site's behavior is like in real time this will help you pivot and obtain additional information for your investigation you might even be able to find related thread actor infrastructure as well again I personally have been using squarex for that exact purpose browse from anywhere and view suspicious websites to see their behavior I used to have to spin up my own browser sandbox and that took a lot of time or I had to wait in a queue until it was my turn which again took a lot of time when you are against an SLA time is money and that's not all square X does have a disposable web browser but it also has a disposable file viewer so that means you can review those PDFs or even Word documents that you and your team receive from fishing alerts you can easily just throw that document in there into that file viewer and see what the contents are this should quickly help you identify if any of those files contain links to sites that are credential Harvesters especially if you do not have a private sandbox again I used to always have to spin on my own sandbox and that took so much time and having this option with square X is great now I know what you might be thinking what happens to my data or is my data being sent over to square X isn't this a privacy issue I'm always skeptical trust me however Square X claims that they do not track or store any of the user data therefore anything that happens within the container is out of their visibility so no law logs are retained and everything all artifacts history Etc are destroyed after the container is disposed I'll leave a link for you down below to sign up with square X really do try them out yourself and if you've used other browser tools before you will love squarex I'll enter in my disposable email from squarex and now let's change the information to provide some details the subject will be mimik cat detected that's a scary subject when you wake up to it to be honest and then I'll put in the time let's head over to our execution arguments and then let's look for UTC time see look at that we're already becoming professionals here type in title and we will put in the title and I think it's useful to put in the computer name as well right if mimik cats is detected you want to know where it was detected from computer perfect awesome wonderful let's go ahead and save that out and we will rerun the workflow heading over to my disposable email from Square X we can click on the new email that was received and look at that shuffle mimik cats detected with the time title and host that is super cool to showcase the responsive feature I deployed another virtual machine because from my testing it seems that the responsive scripts for Windows don't work as well compared to Linux I will use a similar workflow however this time we will add a user input and we will ask the user if they want to block a certain IP now I did not show you the steps on creating a Ubuntu virtual machine and configuring some of the option because I want that to be your lab portion but I will demonstrate the responsive action our goal here is to block any Source IPS that attempts to connect to our Ubuntu machine via SSH to do this you will need to have your Ubuntu machine in the cloud and create a rule to allow all TCP connections towards this Ubuntu machine or you can do this on Prem and use an attacker machine that you own to simulate a SSH Brute Force attack in Shuffle we want to add on the HTTP application so I will go ahead and drag that over I will will rename this as get API and have defined action as curl as for the statement at the bottom you want to include the following and make sure that a firewall rule exists to allow all inbound traffic to Wasa on Port 55,000 now the reason that we are doing this is because if we want to utilize wasa's API capability we must first authenticate and obtain a JWT token AKA a Json web token and in order to do that we need to initiate a curl with a username and password now if you recall there was a Wasa API user that is the user account that we'll be using and then the- k for insecure then get https Wasa IP so your public IP of Wasa on Port 55,000 now Shuffle will be making this request so that is why we need to make sure that that Port is opened for all IP addresses now once you created your firewall rule to allow traffic inbound to Port 55,000 we can now look for wasa's application so let's go ahead and search that and then click it to start downloading it and activating it once you have Wasa activated you can go ahead and drag and drop onto your workflow now I do have to mention when you click on the get API do remember to fill in the user and password for the Wasa AP account and include your Wasa IP here if you leave it as default it's not going to work so I'll just go ahead and change this right now and then I'll save the workflow now that that's good we'll head over to the Wasa application run command is what we want so I'll leave the find action as run command as for the API key we will select our get API at node so if I were to rebuild this workflow just a little bit this is how it will look like the Wasa alert will feed into the get API the get API will then feed over to virus total virus total will run its reputation on the source IP and then virus total will eventually connect to what is called a user input and that will ask the user if they want to block that IP now I don't want to put in the user input yet so I'll just connect virus total over to Wasa that way we can test the responsive capability without constantly asking the user to see if they want to block an IP now that we have wiar connected again the API key we're going to select it as get API for the URL change the Local Host to your vah public IP mine was 159 203 1739 on Port 55,000 if we scroll down we see what is called an agent list each Wasa agent will have an Associated ID with it to find this we can head back over to wasa's dashboard you want to click on the drop- down arrow and select agents as we can see at the bottom the Ubuntu agent ID is 002 yours might be different depending on how many hosts you have but that is how you identify your ID now we can also find this ID in our sample log or alert if we head over to shuffle and click on our execution our person icon and then if we were to expand our execution arguments scroll all the way down there is a section called agent and then there's an ID here in my case the ID is 001 for this Windows machine so as an agents list I can either type it in manually or I can select it to make it Dynamic execution arguments scroll all the way down until I see my agent ID perfect that looks pretty good I will set the weight for complete to true and then we have alert arguments command and custom now before we move on to the next couple fields we must configure active response on our Wasa manager let's head over to our manager console on our manager console we want to open up the osc configuration file scroll all the way down to the bottom and eventually you will find what is called active response now we can always hold down control W and type in active response I butchered that active response there you go so under active response there are some pre-built response options that we will actually be using and if you take a look there are tags called command so here there's a command called disable account the next command is restart Wasa firewall drop post deny and these commands are essentially what you invoke in other words if something bad happens then do this command the most important thing here is that we want to keep keep in mind of the name itself so in my example I'll be using firewall Dash drop this command will modify the IP tables of our Ubuntu machine essentially dropping all traffic to it or to the IP we will now need to create an active response tag and make sure that the command reflects the command name that we want to use for example let me scroll down until there's no more commands and right here we see that the active response options here I'll remove the comment section and then I'll type in command so what is the name of the command that I want to run it is called firewall Dash drop then I want to close out the command tag next is the location tag I'll put this as local and then close that out now what local means is that the host that generated the alert that is where the script will be ran so for example on my Ubuntu machine if there was a malicious IP hitting my Ubuntu machine that is where the script is going to be executed next is level so this is the level of the alert if you recall when we were configuring our Shuffle integration instead of using the level we used rule ID in this case for our active response I'm not going to be using rule ID instead I'm going to be using level I'll close out that tag and finally time out no and now we have our active response so let's go ahead and save this out and we will restart the Wasa manager we can restart it by typing system CTL restart Wasa das manager there is one important thing to keep in mind if you use active response especially when it comes to apis it's that the command name appends the timeout to the name but it is hidden I'll explain currently our Command name was set to firewall Das drop so something like this right but if we want to use this via an API we must append our timeout option to it and there is a hidden timeout field so my timeout was zero or no so now it will append a zero in front of firewall d drop now how would you know that one way to see the name and test to see if your script is active is to use what is called an agent control binary this is located under VAR o bin so let's change our directory there type in LS and we can see a agent uncore control that is the binary that we want so I'll type in agent uncore control and without any options that way we can see what kind of options it provides at the bottom you can see there's a dash capital L this list available active responses so let's go and use that now you can see the response name firewall Das drop Z that is the name we need to use if we want to utilize the API so for example just to make sure everything is Crystal Clear if you set a time OTE option say 600 seconds that means your firewall or command name will be something like firewall ddop 600 and you can always verify using the agent control binary DL to test out your active response actions we can run agent control we'll type in agent control- lowercase b for block and then we'll block the IP address of 8.8.8.8 which is Google's d DNS and then we will specify DF for the active response command now our Command was firewall d drop and because we're using agent control we need to specify the zero next I will specify the dash U for the agent ID 002 and that is my Ubuntu machine now before I execute this active response let's head over to my Ubuntu machine and ping 8.8.8.8 just to make sure it's okay so on my bu to machine I'll go ahead and ping 8.8.8.8 and we can see that it's successful so let's head back over to our Wasa from here we will go ahead and execute our active response and now it says running active response firewall drop on 002 let's head back over to our Ubuntu machine and we see that it stopped I guess it works perfect so let me go ahead and cancel this out and then we'll type in IP tables d-list and then we can see that is it's dropping DNS Google responses we can take a look at our active response log on our Ubuntu machine to see if the active response was successful this can be found under VAR oek logs and if you type in LS we want to look for active responses so we can go ahead and C out active responses and we can see that there are some responses here that was successful you can see that our 8.8.8.8 was here on our Shuffle instance let's add in the command firewall d drop Z we scroll down on our Wasa application we want to select under command firewall Das drop Z and put in the arguments of 8.8.8.8 and I do know that you do need to add in an array now I will save this out and then I will rerun the workflow let's head down to Wasa and expand that out and it says AR command was sent to All agents interesting I only sent it to number two but that's okay so that looks like it's been successful let's go and take a look at our Ubuntu machine on the machine I'll clear this out and then type in active response log now immediately I see an error that says cannot read Source IP from data so we know for a fact that it did not work now just above it we do see our log we see that that the extra arguments our IP is listed in there and it cannot read our source IP from the data but if you recall we did use agent control to execute our active response to test it out and that is this log file right here now we look at the parameters extra arguments and I know it's kind of hard to read with the parameters extra arguments it is blank right here it is blank there's no data and for the alert that is where the source IP lives and if you look at the log that shuffle had sent over there is nothing in the alert itself so that tells me that our IP needs to be in the alert section but just to be safe I am going to copy everything from the alert up to the second curly bracket so I'll go ahead and save that out or copy and then I'll head over to our Shuffle instance on our Shuffle we want to scroll down let's remove the arguments here and under the alert section let's go ahead and paste in our data here now let's go ahead and try that I'll save this out and then we will rerun the execution but before I run that let's set up another ping towards 8.8 on our Ubuntu machine just in case it does work so I'll set out another ping and this is okay head back over to our Shuffle and now we will rerun our workflow now let's scroll all the way down and select our Wasa and again it does say an AR command was sent to all agents so it should be successful if our Command was correctly done let's head over to our Ubuntu and look at that it's stopped I'll exit out of this and then I'll take a look at our IP tables and it's there DNS Google drop all perfect let me go ahead and remove this IP tables D- flush oh I can't spell there you go and now just to double check everything is gone cool perfect so we know for a fact that our Shuffle is sending an active response over to Wasa and Wasa is instructing yuntu to actually perform that command now the next step is to set up a user input that way it will send an email to our stock analyst providing all of that information and if the analyst says yes go ahead and block it wasas should instruct yuntu to block that IP so the only thing that we need to add now is let's remove this chain or that link and then we'll go under triggers and we want to drag over user input I'll connect virus total over to the user input and here I'll make sure that the email is selected and I'll use my trusty disposable email from squarex because I don't want to use my personal email for the sake of the demo we can just say would you like to block this Source IP and what is the source IP let's let's go take a look here we can just click click on this plus icon and then look at the execution arguments so here's the source IP that we're interested in so I'll highlight this and then I'll copy it I'll remove it and then head over to the user input and then I will paste in the variable now if you're following along you might be like what the heck did I just do going back I I was just using virus totals query input to take a look at what the variable for the source IP was so in order to do that I just clicked on the plus button looked at the execution argument and then I tried to find out where the source IP was and it was located at the bottom and if I didn't know for sure I looked at the value that was presented to me on the left so I clicked on Source IP and then I just took the variable here copied it removed it because I don't want virus total to take a look at it instead I added it over to our user input so in theory if this workflow ran it would ask the user if they would like to block this Source IP and it will also present the source IP to the the analyst and if the analyst says yes I want to block that Source IP the responsive feature should then kick in so let's go ahead and connect that over to our Wasa make sure our Command is all good to go now the source IP is no longer going to be a static IP instead I'm going to remove that and then I will select the plus icon execution arguments scroll all the way down to Source IP and then I'll select that and I notice that the variable is outside of the bracket so I'll remove that and then put it in between the quotes there you go now that looks a lot better and a lot cleaner I'll go ahead and save this workflow out and now it's the moment of truth I'm going to take a look at what the source IP is in this case so the source IP is 103.1 18049 do26 I'm going to go ahead and ping out that IP hopefully they accept pings perfect so they do accept pings let's hope our sore workflow Works under our workflow we will rerun the workflow so once we run it it should go out and grab the API key for Wasa then it will enrich the data in this case with IP and then it will send an email to our analyst and depending on its response it should activate a respon of action let's head over to our disposable email click on inbox and let's refresh this and here we go we have an email here it says would you like to block the source IP 103.1 1801 4926 if this is true click this in other words if you want to block it access this link yes I want to block it let's go ahead and do that in here it says would you like to block the source IP and it automatically selected continue for me so the next thing to do now is head over to our Ubuntu machine and see if our active response kicked in and because there's just way too many going on I'll go ahead and exit that out and then I'll type in my IP tables let's list it out and our IP of 103.1 18049 26 has been added to our IP tables our active response actions kicked in from here the sky is the limit and it is up to your imagination on what you want to do with this automation perhaps you want to automatically reset an account from active directory if a user entered in their credentials onto a fishing page or maybe you want to contain a host if there was suspicious activity such as our mimik cats example automation is something to really think about as this is the direction that we're heading towards now again I did not go through the last portion in detail intentionally because I want you to get some hands-on experience and try it out yourself if you are up for that now here's your homework you want to create a Ubuntu machine in the cloud with the lowest minimum specs so 1 gig and 25 hard drive space you want to make sure you use a password generator so it is not easy to guess this machine should allow all traffic inbound meaning all sources will have access to your Ubuntu machine you want to install a Wasa agent onto that Ubuntu machine and then immediately you should see multiple failed SSH attempt alerts push all level five alerts to shuffle and perform IP enrichment using virus total send the details via email to the user asking if the user wants to block the IP and automatically create an alert in the hive if the user selects yes to block the IP should automatically be placed in IP tables if you are a student or a professional that wants to transition into cyber security I want you to know that I offer free mentorship on my site with no strings attached on there you will also see products that I personally created in which you can download to help guide you along this journey these products include resume and cover letter templates bookmarks a one-year road map on how to get started in cyber security and a list of interview questions to help you in your next interview also as a sneak peek I am in the process of creating a sock course where there will will be over 20 Hands-On labs and multiple projects that you can put onto your resume you can join the wait list if you choose to do so my mission here is to help you get to where you want to be and that is it for the series I hope you enjoyed it as much as I did making it please share this video to other aspiring analysts so they can get some hands-on experience as well thank you so much for watching And subscribe if you want to remember to stay curious and do things differently
